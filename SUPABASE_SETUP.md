# Supabase Setup Guide for ClaimStream Extension

This guide will help you set up Supabase for the ClaimStream Chrome Extension.

## Prerequisites

- A Supabase account (sign up at https://supabase.com)
- Basic knowledge of SQL and database management

## Step 1: Create a New Supabase Project

1. Go to https://supabase.com and sign in
2. Click "New Project"
3. Choose your organization
4. Enter project details:
   - **Name**: `claimstream-extension`
   - **Database Password**: Generate a strong password (save it!)
   - **Region**: Choose closest to your users
5. Click "Create new project"
6. Wait for the project to be created (2-3 minutes)

## Step 2: Set Up Database Tables

1. Go to your project dashboard
2. Click on "SQL Editor" in the left sidebar
3. Run the following SQL commands to create the required tables:

### Create Custom Types

```sql
-- Create custom enum types
CREATE TYPE public.reportStatus AS ENUM ('Processing', 'Complete', 'Failed');
CREATE TYPE public.verificationStatus AS ENUM ('Verified', 'False', 'Misleading', 'Unverified', 'Partially_True');
```

### Create Tables

```sql
-- Create analysis_reports table
CREATE TABLE public.analysis_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid (),
  source_url text NULL,
  summary text NULL,
  created_at timestamp WITH TIME ZONE NULL DEFAULT now(),
  video_title text NULL,
  video_channel_title text NULL,
  video_duration integer NULL,
  video_channel_id text NULL,
  video_thumbnail_image text NULL,
  video_statistics jsonb NULL,
  analysis_status public.reportStatus NULL,
  video_id text NULL,
  CONSTRAINT analysis_reports_pkey PRIMARY KEY (id)
) TABLESPACE pg_default;

-- Create verified_claims table
CREATE TABLE public.verified_claims (
  id uuid NOT NULL DEFAULT gen_random_uuid (),
  report_id uuid NULL,
  original_statement text NULL,
  participant text NULL,
  verification_status public.verificationStatus NULL,
  verification_summary text NULL,
  supporting_evidence jsonb NULL,
  secondary_data jsonb NULL,
  created_at timestamp WITH TIME ZONE NULL DEFAULT now(),
  CONSTRAINT verified_claims_pkey PRIMARY KEY (id),
  CONSTRAINT verified_claims_report_id_fkey FOREIGN KEY (report_id) REFERENCES analysis_reports (id)
) TABLESPACE pg_default;

-- Create configs table
CREATE TABLE public.configs (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at timestamp WITH TIME ZONE NOT NULL DEFAULT now(),
  "n8nWebhookUrl" text NULL,
  CONSTRAINT configs_pkey PRIMARY KEY (id)
) TABLESPACE pg_default;
```

### Enable Row Level Security (RLS)

```sql
-- Enable RLS on tables
ALTER TABLE public.analysis_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.verified_claims ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.configs ENABLE ROW LEVEL SECURITY;
```

### Create RLS Policies

#### For Development/Testing (Permissive Policies)

```sql
-- Analysis Reports - Allow all operations for development
CREATE POLICY "dev_analysis_reports_select" ON public.analysis_reports 
  FOR SELECT USING (true);

CREATE POLICY "dev_analysis_reports_insert" ON public.analysis_reports 
  FOR INSERT WITH CHECK (true);

CREATE POLICY "dev_analysis_reports_update" ON public.analysis_reports 
  FOR UPDATE USING (true);

-- Verified Claims - Allow all operations for development
CREATE POLICY "dev_verified_claims_select" ON public.verified_claims 
  FOR SELECT USING (true);

CREATE POLICY "dev_verified_claims_insert" ON public.verified_claims 
  FOR INSERT WITH CHECK (true);

CREATE POLICY "dev_verified_claims_update" ON public.verified_claims 
  FOR UPDATE USING (true);

-- Configs - Read-only for anon users (webhook URL retrieval)
CREATE POLICY "configs_read_only" ON public.configs 
  FOR SELECT USING (true);
```

#### For Production (Secure Policies)

```sql
-- First, drop the development policies when ready for production:
-- DROP POLICY "dev_analysis_reports_select" ON public.analysis_reports;
-- DROP POLICY "dev_analysis_reports_insert" ON public.analysis_reports;
-- DROP POLICY "dev_analysis_reports_update" ON public.analysis_reports;
-- DROP POLICY "dev_verified_claims_select" ON public.verified_claims;
-- DROP POLICY "dev_verified_claims_insert" ON public.verified_claims;
-- DROP POLICY "dev_verified_claims_update" ON public.verified_claims;

-- Production policies (uncomment when you have authentication):

-- Analysis Reports - User can only access their own reports
-- CREATE POLICY "user_analysis_reports_select" ON public.analysis_reports 
--   FOR SELECT USING (auth.uid() = user_id);

-- CREATE POLICY "user_analysis_reports_insert" ON public.analysis_reports 
--   FOR INSERT WITH CHECK (auth.uid() = user_id);

-- CREATE POLICY "user_analysis_reports_update" ON public.analysis_reports 
--   FOR UPDATE USING (auth.uid() = user_id);

-- Verified Claims - User can only access claims from their reports
-- CREATE POLICY "user_verified_claims_select" ON public.verified_claims 
--   FOR SELECT USING (
--     EXISTS (
--       SELECT 1 FROM public.analysis_reports 
--       WHERE analysis_reports.id = verified_claims.report_id 
--       AND analysis_reports.user_id = auth.uid()
--     )
--   );

-- CREATE POLICY "user_verified_claims_insert" ON public.verified_claims 
--   FOR INSERT WITH CHECK (
--     EXISTS (
--       SELECT 1 FROM public.analysis_reports 
--       WHERE analysis_reports.id = verified_claims.report_id 
--       AND analysis_reports.user_id = auth.uid()
--     )
--   );

-- Configs - Read-only for all authenticated users
-- CREATE POLICY "authenticated_configs_read" ON public.configs 
--   FOR SELECT USING (auth.role() = 'authenticated');
```

**Important Notes:**
- Start with **development policies** for testing
- The production policies assume you'll add a `user_id` column to `analysis_reports`
- Production policies require Firebase Auth integration
- The `configs` table should be read-only for client access

### Schema Modifications for Production

When you're ready to implement user authentication, you'll need to add user tracking:

```sql
-- Add user_id column to analysis_reports for user ownership
ALTER TABLE public.analysis_reports 
ADD COLUMN user_id uuid REFERENCES auth.users(id);

-- Create index for better performance
CREATE INDEX idx_analysis_reports_user_id ON public.analysis_reports(user_id);

-- Update the supabase client to include user_id when creating reports
```

### Insert Initial Configuration

```sql
-- Insert your webhook URL into the configs table
INSERT INTO public.configs ("n8nWebhookUrl") 
VALUES ('https://your-n8n-instance.com/webhook/your-webhook-id');

-- Replace with your actual n8n webhook URL
-- Example: 'https://n8n.example.com/webhook/abc123-def456-ghi789'
```

## Step 3: Enable Realtime

1. Go to "Database" → "Replication" in your Supabase dashboard
2. Enable replication for the following tables:
   - `analysis_reports`
   - `verified_claims`
3. This allows real-time subscriptions to work

## Step 4: Get Your Project Credentials

1. Go to "Settings" → "API" in your Supabase dashboard
2. Copy the following values:
   - **Project URL** (e.g., `https://your-project.supabase.co`)
   - **anon public key** (starts with `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`)

## Step 5: Configure the Extension

1. Open `config.js` in your extension folder
2. Update the Supabase configuration:

```javascript
const CONFIG = {
  supabase: {
    url: 'https://your-project.supabase.co', // Replace with your Project URL
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...', // Replace with your anon key
  },
  // ... rest of config
};
```

## Step 6: Test the Connection

1. Reload your Chrome extension
2. Navigate to a YouTube video
3. Open the extension popup
4. Check the browser console for:
   - "Supabase client initialized successfully"
   - No connection errors

## Step 7: Test Database Operations

1. Click "Analyze Claims" on a YouTube video
2. Check the Supabase dashboard:
   - Go to "Table Editor"
   - Look for new entries in `analysis_reports` table
3. Check browser console for successful database operations

## Step 8: Test Webhook Integration

1. **Configure your webhook URL** in the `configs` table (see Step 2)
2. **Test the webhook flow**:
   - Navigate to a YouTube video
   - Open the extension popup
   - Click "Analyze Claims"
   - Watch the console for webhook trigger logs
3. **Expected flow**:
   - Extension gets webhook URL from configs table
   - Creates analysis report in database
   - Triggers GET request to webhook with `VideoURL` parameter
   - Sets up real-time subscription for updates
4. **Verify webhook call**:
   - Check your n8n workflow logs
   - Webhook should receive: `https://your-webhook-url?VideoURL=https://www.youtube.com/watch?v=VIDEO_ID`

## Security Notes

⚠️ **Important**: The current setup uses public policies for development. For production:

1. Implement proper authentication (Firebase Auth integration)
2. Restrict RLS policies based on user authentication
3. Use Supabase Edge Functions for sensitive operations
4. Never expose service role keys in the extension

## Troubleshooting

### Common Issues:

1. **"Supabase client not initialized"**
   - Check that your URL and anon key are correct
   - Verify the Supabase CDN is loading

2. **Database connection errors**
   - Ensure your project is not paused
   - Check network connectivity
   - Verify RLS policies allow the operations

3. **Real-time subscriptions not working**
   - Ensure replication is enabled for the tables
   - Check that the subscription channel names are unique

### Debug Steps:

1. Open browser console and look for error messages
2. Check the Network tab for failed requests
3. Verify table structure in Supabase dashboard
4. Test database operations directly in Supabase SQL Editor

## Next Steps

Once Supabase is working:

1. Set up Firebase Authentication
2. Create Supabase Edge Functions
3. Integrate with n8n workflow
4. Implement proper error handling and retry logic

## Support

If you encounter issues:
- Check the Supabase documentation: https://supabase.com/docs
- Review the browser console for error messages
- Verify your database schema matches the requirements
